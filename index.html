<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é›²ç«¯å·¥ç¨‹æª¢æŸ¥ PWA (å®Œæ•´ç‰ˆ)</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f3f4f6; padding-bottom: 100px; }
        .paper-card { background: white; padding: 16px; margin-bottom: 16px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .input-std { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #fafafa; }
        
        /* æŒ‰éˆ•æ¨£å¼ */
        .btn-base { padding: 12px 0; border: 1px solid #e5e7eb; border-radius: 6px; font-weight: bold; color: #6b7280; background: white; transition: all 0.2s; }
        .btn-pass-active { background-color: #10b981; color: white; border-color: #10b981; }
        .btn-fail-active { background-color: #ef4444; color: white; border-color: #ef4444; }
        
        /* ç›¸æ©Ÿé è¦½å€ */
        .photo-preview { width: 100%; height: 200px; object-fit: cover; border-radius: 8px; border: 2px dashed #ccc; display: none; margin-top: 10px; }
        .photo-preview.show { display: block; border: 2px solid #2563eb; }
        
        /* è¼‰å…¥å‹•ç•« */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #2563eb; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4">

    <header class="mb-4 flex justify-between items-center">
        <div>
            <h1 class="text-xl font-bold text-gray-800">å·¥ç¨‹å“è³ªè‡ªä¸»æª¢æŸ¥</h1>
            <p class="text-xs text-blue-600 font-bold flex items-center gap-1">
                <span class="relative flex h-2 w-2"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span><span class="relative inline-flex rounded-full h-2 w-2 bg-blue-500"></span></span>
                é›²ç«¯é€£ç·šæ¨¡å¼
            </p>
        </div>
        <button onclick="fetchConfig()" class="text-xs bg-white border border-gray-300 px-3 py-2 rounded shadow-sm hover:bg-gray-50">ğŸ”„ æ›´æ–°è¡¨å–®</button>
    </header>

    <div class="paper-card border-l-4 border-blue-500">
        <label class="block text-gray-500 text-xs mb-1 font-bold">é¸æ“‡æª¢æŸ¥å·¥é … (ä¾†è‡ª Google Sheet)</label>
        <select id="formSelector" onchange="renderChecklist()" class="w-full p-3 border-2 border-blue-100 rounded-lg bg-blue-50 font-bold text-lg mb-4 text-blue-800 focus:outline-none focus:border-blue-500">
            <option>æ­£åœ¨é€£ç·šé›²ç«¯...</option>
        </select>
        
        <div class="grid grid-cols-2 gap-3 pt-3 border-t">
            <div>
                <label class="text-xs text-gray-500 block mb-1">æª¢æŸ¥æ—¥æœŸ</label>
                <input type="date" id="checkDate" class="input-std">
            </div>
            <div>
                <label class="text-xs text-gray-500 block mb-1">æª¢æŸ¥äººå“¡</label>
                <input type="text" id="inspector" class="input-std" value="æ—å©‰é¦¨">
            </div>
        </div>
    </div>

    <div id="loading" class="loader hidden"></div>

    <div id="checklistArea" class="space-y-4"></div>

    <div class="fixed bottom-0 left-0 w-full bg-white border-t p-4 shadow-lg z-50">
        <button onclick="submitToCloud()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg shadow-lg hover:bg-blue-700 active:scale-95 transition-transform flex justify-center items-center gap-2">
            <span>â˜ï¸</span> ä¸Šå‚³è³‡æ–™åˆ°é›²ç«¯
        </button>
    </div>

<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js'));
    }

    // ============================================================
    // â˜…â˜…â˜… æ‚¨çš„å°ˆå±¬ Google Apps Script ç¶²å€ â˜…â˜…â˜…
    // ============================================================
    const API_URL = "https://script.google.com/macros/s/AKfycbzE-mAK3vhaI91zBS-Bmx7QKlaCo5aSkLk5ZSgozKWldRHtkkqAR4npw8tRSZRT8_nO9w/exec"; 
    
    let appConfig = {}; 
    let currentResults = {}; 

    // åˆå§‹åŒ–
    document.getElementById('checkDate').valueAsDate = new Date();
    fetchConfig(); 

    // 1. å¾ Google Sheet æŠ“å–è¨­å®š
    function fetchConfig() {
        const select = document.getElementById('formSelector');
        const loader = document.getElementById('loading');
        
        select.innerHTML = '<option>é€£ç·šæ›´æ–°ä¸­...</option>';
        select.disabled = true;
        loader.classList.remove('hidden');

        fetch(API_URL)
            .then(res => res.json())
            .then(data => {
                appConfig = data;
                updateSelector();
                loader.classList.add('hidden');
                Swal.fire({ icon: 'success', title: 'é›²ç«¯è¡¨å–®å·²åŒæ­¥', timer: 1000, showConfirmButton: false });
            })
            .catch(err => {
                console.error(err);
                select.innerHTML = '<option>é€£ç·šå¤±æ•—</option>';
                loader.classList.add('hidden');
                Swal.fire('é€£ç·šéŒ¯èª¤', 'ç„¡æ³•è®€å– Google Sheetï¼Œè«‹æª¢æŸ¥ç¶²å€æˆ–ç¶²è·¯', 'error');
            });
    }

    function updateSelector() {
        const select = document.getElementById('formSelector');
        select.innerHTML = '';
        select.disabled = false;

        Object.keys(appConfig).forEach(key => {
            let opt = document.createElement('option');
            opt.value = key;
            opt.innerText = appConfig[key].title;
            select.appendChild(opt);
        });
        
        renderChecklist(); 
    }

    // 2. ç¹ªè£½æª¢æŸ¥è¡¨ (å«ç›¸æ©ŸåŠŸèƒ½)
    function renderChecklist() {
        const key = document.getElementById('formSelector').value;
        if(!appConfig[key]) return;

        const items = appConfig[key].items;
        const container = document.getElementById('checklistArea');
        let html = '';
        currentResults = {}; 

        items.forEach((item, idx) => {
            // åˆå§‹åŒ–è³‡æ–™çµæ§‹
            currentResults[item.id] = { 
                name: item.name,
                result: '', 
                note: '', 
                photo: '' // é ç•™ç…§ç‰‡æ¬„ä½
            };

            html += `
            <div class="paper-card transition-all" id="card-${item.id}">
                <div class="flex justify-between items-start mb-2">
                    <h3 class="font-bold text-gray-800 text-lg">${idx + 1}. ${item.name}</h3>
                </div>
                <div class="bg-gray-100 p-2 rounded text-sm text-gray-600 mb-3 border-l-4 border-gray-400">
                    <span class="font-bold">æ¨™æº–ï¼š</span>${item.standard}
                </div>
                
                <div class="space-y-3">
                    <input type="text" class="input-std" placeholder="è¼¸å…¥æª¢æŸ¥æ•¸å€¼æˆ–å‚™è¨»..." 
                        onchange="currentResults['${item.id}'].note = this.value">
                    
                    <div class="w-full">
                        <input type="file" id="cam-${item.id}" accept="image/*" capture="environment" class="hidden" onchange="handleImage(this, '${item.id}')">
                        <button onclick="document.getElementById('cam-${item.id}').click()" 
                            class="w-full py-2 rounded border border-dashed border-gray-400 text-gray-600 font-bold hover:bg-gray-50 flex justify-center items-center gap-2">
                            ğŸ“· æ‹æ”ç…§ç‰‡
                        </button>
                        
                        <div class="relative">
                            <img id="img-${item.id}" class="photo-preview mt-2">
                            <button id="del-${item.id}" onclick="clearImage('${item.id}')" class="hidden absolute top-4 right-2 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center shadow">âœ•</button>
                        </div>
                    </div>

                    <div class="flex gap-2 pt-2 border-t mt-2">
                        <button onclick="setResult('${item.id}', 'pass', this)" class="btn-base flex-1">åˆæ ¼</button>
                        <button onclick="setResult('${item.id}', 'fail', this)" class="btn-base flex-1">ç¼ºå¤±</button>
                    </div>
                </div>
            </div>`;
        });
        container.innerHTML = html;
    }

    // è™•ç†ç…§ç‰‡ (è½‰ Base64 ä¾›é è¦½èˆ‡ä¸Šå‚³)
    function handleImage(input, id) {
        if (input.files && input.files[0]) {
            // é™åˆ¶æª”æ¡ˆå¤§å° (ç°¡æ˜“å‰ç«¯å£“ç¸®æ¦‚å¿µ)
            const file = input.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const base64Data = e.target.result;
                
                // 1. é¡¯ç¤ºé è¦½
                const img = document.getElementById(`img-${id}`);
                img.src = base64Data;
                img.classList.add('show');
                document.getElementById(`del-${id}`).classList.remove('hidden');

                // 2. å­˜å…¥æš«å­˜ç‰©ä»¶
                // æ¨™è¨˜æœ‰ç…§ç‰‡ï¼Œå›  Google Sheet æ¬„ä½é™åˆ¶ï¼Œæš«æ™‚ä¸å­˜å®Œæ•´ Base64
                currentResults[id].photo = "æœ‰ç…§ç‰‡(å¾…ä¸Šå‚³)"; 
                
                // æ”¹è®ŠæŒ‰éˆ•æ¨£å¼
                input.nextElementSibling.innerText = "âœ… ç…§ç‰‡å·²æš«å­˜";
                input.nextElementSibling.classList.add("bg-blue-50", "text-blue-600", "border-blue-200");
            }
            reader.readAsDataURL(file);
        }
    }

    function clearImage(id) {
        const input = document.getElementById(`cam-${id}`);
        input.value = "";
        document.getElementById(`img-${id}`).classList.remove('show');
        document.getElementById(`del-${id}`).classList.add('hidden');
        currentResults[id].photo = "";
        
        input.nextElementSibling.innerText = "ğŸ“· æ‹æ”ç…§ç‰‡";
        input.nextElementSibling.classList.remove("bg-blue-50", "text-blue-600", "border-blue-200");
    }

    function setResult(id, status, btn) {
        currentResults[id].result = status;
        const parent = btn.parentElement;
        parent.querySelectorAll('button').forEach(b => b.className = "btn-base flex-1");
        
        if(status === 'pass') btn.className = "btn-base flex-1 btn-pass-active";
        else btn.className = "btn-base flex-1 btn-fail-active";
    }

    // 3. ä¸Šå‚³è³‡æ–™
    function submitToCloud() {
        const inspector = document.getElementById('inspector').value;
        const formKey = document.getElementById('formSelector').value;
        const formTitle = appConfig[formKey].title;
        const date = document.getElementById('checkDate').value;
        
        // æº–å‚™è¦å‚³é€çš„è³‡æ–™åŒ…
        const payload = {
            date: date,
            inspector: inspector,
            formType: formTitle,
            results: currentResults // åŒ…å«æ¯å€‹é …ç›®çš„çµæœã€å‚™è¨»ã€ç…§ç‰‡æ¨™è¨˜
        };

        Swal.fire({ 
            title: 'ä¸Šå‚³ä¸­...', 
            text: 'æ­£åœ¨å¯«å…¥ Google Sheet', 
            allowOutsideClick: false, 
            didOpen: () => Swal.showLoading() 
        });

        fetch(API_URL, {
            method: 'POST',
            mode: 'no-cors', // è·¨åŸŸæ¨¡å¼
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        }).then(() => {
            Swal.fire('æˆåŠŸ', 'è³‡æ–™å·²å­˜å…¥é›²ç«¯ï¼\n(ç›®å‰ç…§ç‰‡åŠŸèƒ½é¡¯ç¤ºç‚ºæ–‡å­—æ¨™è¨˜)', 'success');
        }).catch(err => {
            Swal.fire('å¤±æ•—', 'ä¸Šå‚³ç™¼ç”ŸéŒ¯èª¤', 'error');
        });
    }
</script>

</body>
</html>