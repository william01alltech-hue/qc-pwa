<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é›²ç«¯å·¥ç¨‹æª¢æŸ¥ PWA (ç…§ç‰‡ç‰ˆ)</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f3f4f6; padding-bottom: 100px; }
        .paper-card { background: white; padding: 16px; margin-bottom: 16px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .input-std { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #fafafa; }
        .btn-base { padding: 12px 0; border: 1px solid #e5e7eb; border-radius: 6px; font-weight: bold; color: #6b7280; background: white; transition: all 0.2s; }
        .btn-pass-active { background-color: #10b981; color: white; border-color: #10b981; }
        .btn-fail-active { background-color: #ef4444; color: white; border-color: #ef4444; }
        .photo-preview { width: 100%; height: 200px; object-fit: cover; border-radius: 8px; border: 2px dashed #ccc; display: none; margin-top: 10px; }
        .photo-preview.show { display: block; border: 2px solid #2563eb; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #2563eb; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4">

    <header class="mb-4 flex justify-between items-center">
        <div>
            <h1 class="text-xl font-bold text-gray-800">å·¥ç¨‹å“è³ªè‡ªä¸»æª¢æŸ¥</h1>
            <p class="text-xs text-blue-600 font-bold">â— å·²é€£ç·šè‡³é›²ç«¯ç¡¬ç¢Ÿ</p>
        </div>
        <button onclick="fetchConfig()" class="text-xs bg-white border border-gray-300 px-3 py-2 rounded shadow-sm">ğŸ”„ æ›´æ–°</button>
    </header>

    <div class="paper-card border-l-4 border-blue-500">
        <label class="block text-gray-500 text-xs mb-1 font-bold">é¸æ“‡æª¢æŸ¥å·¥é …</label>
        <select id="formSelector" onchange="renderChecklist()" class="w-full p-3 border-2 border-blue-100 rounded-lg bg-blue-50 font-bold text-lg mb-4 text-blue-800 focus:outline-none">
            <option>æ­£åœ¨é€£ç·š...</option>
        </select>
        
        <div class="grid grid-cols-2 gap-3 pt-3 border-t">
            <div><label class="text-xs text-gray-500">æ—¥æœŸ</label><input type="date" id="checkDate" class="input-std"></div>
            <div><label class="text-xs text-gray-500">äººå“¡</label><input type="text" id="inspector" class="input-std" value="æ—å©‰é¦¨"></div>
        </div>
    </div>

    <div id="loading" class="loader hidden"></div>
    <div id="checklistArea" class="space-y-4"></div>

    <div class="fixed bottom-0 left-0 w-full bg-white border-t p-4 shadow-lg z-50">
        <button onclick="submitToCloud()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg shadow-lg flex justify-center items-center gap-2">
            <span>â˜ï¸</span> ä¸Šå‚³è³‡æ–™ (å«ç…§ç‰‡)
        </button>
    </div>

<script>
    if ('serviceWorker' in navigator) window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js'));

    // â˜…â˜…â˜… è«‹ç¢ºèªé€™è£¡æ˜¯å¦ç‚ºæ‚¨çš„ Apps Script ç¶²å€ â˜…â˜…â˜…
    const API_URL = "https://script.google.com/macros/s/AKfycbzE-mAK3vhaI91zBS-Bmx7QKlaCo5aSkLk5ZSgozKWldRHtkkqAR4npw8tRSZRT8_nO9w/exec"; 
    
    let appConfig = {}; 
    let currentResults = {}; 

    document.getElementById('checkDate').valueAsDate = new Date();
    fetchConfig(); 

    function fetchConfig() {
        const select = document.getElementById('formSelector');
        const loader = document.getElementById('loading');
        select.disabled = true;
        loader.classList.remove('hidden');

        fetch(API_URL)
            .then(res => res.json())
            .then(data => {
                appConfig = data;
                updateSelector();
                loader.classList.add('hidden');
            })
            .catch(err => {
                console.error(err);
                select.innerHTML = '<option>é€£ç·šå¤±æ•—</option>';
                loader.classList.add('hidden');
                Swal.fire('éŒ¯èª¤', 'ç„¡æ³•é€£ç·šåˆ° Google Sheet', 'error');
            });
    }

    function updateSelector() {
        const select = document.getElementById('formSelector');
        select.innerHTML = '';
        select.disabled = false;
        Object.keys(appConfig).forEach(key => {
            let opt = document.createElement('option');
            opt.value = key;
            opt.innerText = appConfig[key].title;
            select.appendChild(opt);
        });
        renderChecklist(); 
    }

    function renderChecklist() {
        const key = document.getElementById('formSelector').value;
        if(!appConfig[key]) return;
        const items = appConfig[key].items;
        const container = document.getElementById('checklistArea');
        let html = '';
        currentResults = {}; 

        items.forEach((item, idx) => {
            currentResults[item.id] = { name: item.name, result: '', note: '', photo: '' };

            html += `
            <div class="paper-card transition-all" id="card-${item.id}">
                <div class="font-bold text-gray-800 text-lg mb-1">${idx + 1}. ${item.name}</div>
                <div class="bg-gray-100 p-2 rounded text-sm text-gray-600 mb-2">æ¨™æº–ï¼š${item.standard}</div>
                
                <input type="text" class="input-std mb-2" placeholder="å‚™è¨»..." onchange="currentResults['${item.id}'].note = this.value">
                
                <div class="w-full">
                    <input type="file" id="cam-${item.id}" accept="image/*" capture="environment" class="hidden" onchange="handleImage(this, '${item.id}')">
                    <button onclick="document.getElementById('cam-${item.id}').click()" class="w-full py-2 border border-dashed border-gray-400 text-gray-600 font-bold hover:bg-gray-50">ğŸ“· æ‹æ”ç…§ç‰‡</button>
                    <div class="relative">
                        <img id="img-${item.id}" class="photo-preview mt-2">
                        <button id="del-${item.id}" onclick="clearImage('${item.id}')" class="hidden absolute top-4 right-2 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center">âœ•</button>
                    </div>
                </div>

                <div class="flex gap-2 pt-2 border-t mt-2">
                    <button onclick="setResult('${item.id}', 'pass', this)" class="btn-base flex-1">åˆæ ¼</button>
                    <button onclick="setResult('${item.id}', 'fail', this)" class="btn-base flex-1">ç¼ºå¤±</button>
                </div>
            </div>`;
        });
        container.innerHTML = html;
    }

    function handleImage(input, id) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            // ç°¡å–®å£“ç¸®æª¢æŸ¥ï¼šè¶…é 3MB è­¦å‘Š
            if(file.size > 3 * 1024 * 1024) {
                Swal.fire('ç…§ç‰‡å¤ªå¤§', 'è«‹ä½¿ç”¨è¼ƒä½è§£æåº¦æ‹æ”ä»¥åŠ é€Ÿä¸Šå‚³', 'warning');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const base64Data = e.target.result;
                const img = document.getElementById(`img-${id}`);
                img.src = base64Data;
                img.classList.add('show');
                document.getElementById(`del-${id}`).classList.remove('hidden');
                
                // â˜… é€™è£¡å‚³é€çœŸå¯¦ç…§ç‰‡è³‡æ–™ â˜…
                currentResults[id].photo = base64Data; 
                
                input.nextElementSibling.innerText = "âœ… ç…§ç‰‡å·²æš«å­˜";
                input.nextElementSibling.classList.add("bg-blue-50", "text-blue-600", "border-blue-200");
            }
            reader.readAsDataURL(file);
        }
    }

    function clearImage(id) {
        const input = document.getElementById(`cam-${id}`);
        input.value = "";
        document.getElementById(`img-${id}`).classList.remove('show');
        document.getElementById(`del-${id}`).classList.add('hidden');
        currentResults[id].photo = "";
        input.nextElementSibling.innerText = "ğŸ“· æ‹æ”ç…§ç‰‡";
        input.nextElementSibling.classList.remove("bg-blue-50", "text-blue-600", "border-blue-200");
    }

    function setResult(id, status, btn) {
        currentResults[id].result = status;
        const parent = btn.parentElement;
        parent.querySelectorAll('button').forEach(b => b.className = "btn-base flex-1");
        if(status === 'pass') btn.className = "btn-base flex-1 btn-pass-active";
        else btn.className = "btn-base flex-1 btn-fail-active";
    }

    function submitToCloud() {
        const inspector = document.getElementById('inspector').value;
        const formKey = document.getElementById('formSelector').value;
        const formTitle = appConfig[formKey].title;
        const date = document.getElementById('checkDate').value;
        
        const payload = {
            date: date,
            inspector: inspector,
            formType: formTitle,
            results: currentResults
        };

        Swal.fire({ 
            title: 'ä¸Šå‚³ä¸­...', 
            text: 'ç…§ç‰‡è¼ƒå¤§è«‹ç¨å€™ (ç´„5-10ç§’)', 
            allowOutsideClick: false, 
            didOpen: () => Swal.showLoading() 
        });

        fetch(API_URL, {
            method: 'POST',
            mode: 'no-cors', 
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        }).then(() => {
            Swal.fire('æˆåŠŸ', 'è³‡æ–™èˆ‡ç…§ç‰‡å·²å­˜å…¥é›²ç«¯ï¼', 'success');
        }).catch(err => {
            Swal.fire('å¤±æ•—', 'ä¸Šå‚³ç™¼ç”ŸéŒ¯èª¤', 'error');
        });
    }
</script>

</body>
</html>