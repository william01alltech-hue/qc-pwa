<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2563eb">
    <title>å·¥ç¨‹æª¢æŸ¥ PWA (å«å¾Œå°)</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f3f4f6; padding-bottom: 80px; }
        .paper-card { background: white; padding: 16px; margin-bottom: 16px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .input-std { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #fafafa; }
        
        /* é é¢åˆ‡æ›æ§åˆ¶ */
        .page-section { display: none; }
        .page-section.active { display: block; }

        /* åº•éƒ¨å°èˆªåˆ— */
        .nav-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 1px solid #ddd; display: flex; justify-content: space-around; padding: 10px 0; z-index: 100; }
        .nav-item { text-align: center; color: #9ca3af; font-size: 12px; cursor: pointer; }
        .nav-item.active { color: #2563eb; font-weight: bold; }
        .nav-icon { font-size: 24px; display: block; margin-bottom: 2px; }

        /* ç›¸æ©Ÿèˆ‡æŒ‰éˆ•æ¨£å¼ */
        .btn-base { padding: 10px 0; border: 1px solid #e5e7eb; border-radius: 6px; font-weight: bold; color: #6b7280; background: white; }
        .btn-pass-active { background-color: #10b981; color: white; border-color: #10b981; }
        .btn-fail-active { background-color: #ef4444; color: white; border-color: #ef4444; }
        .photo-preview { width: 100%; height: 180px; object-fit: cover; border-radius: 8px; border: 2px dashed #ccc; display: none; margin-top: 8px; }
        .photo-preview.show { display: block; border: 2px solid #2563eb; }
    </style>
</head>
<body class="p-4">

    <div id="page-check" class="page-section active">
        <header class="mb-4 flex justify-between items-center">
            <h1 class="text-xl font-bold text-gray-800">å·¥ç¨‹å“è³ªè‡ªä¸»æª¢æŸ¥</h1>
            <div class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">ç¾å ´æ¨¡å¼</div>
        </header>

        <div class="paper-card border-l-4 border-blue-500">
            <label class="block text-gray-500 text-xs mb-1">è«‹é¸æ“‡æª¢æŸ¥è¡¨ï¼š</label>
            <select id="userFormSelector" onchange="loadUserForm()" class="w-full p-2 border rounded bg-white font-bold text-lg mb-3"></select>
            
            <div class="grid grid-cols-2 gap-3 pt-2 border-t">
                <div><label class="text-xs text-gray-500">æ—¥æœŸ</label><input type="date" id="checkDate" class="input-std"></div>
                <div><label class="text-xs text-gray-500">äººå“¡</label><input type="text" class="input-std" value="æ—å©‰é¦¨"></div>
            </div>
        </div>

        <div id="checklistArea"></div>
        
        <button onclick="submitData()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg shadow mt-4 mb-20">æäº¤æª¢æŸ¥ç´€éŒ„</button>
    </div>

    <div id="page-admin" class="page-section">
        <header class="mb-4 flex justify-between items-center">
            <h1 class="text-xl font-bold text-gray-800">ç®¡ç†å“¡å¾Œå°è¨­å®š</h1>
            <div class="text-xs bg-gray-200 text-gray-800 px-2 py-1 rounded">è¨­å®šæ¨¡å¼</div>
        </header>

        <div class="paper-card bg-gray-50">
            <h3 class="font-bold text-gray-700 mb-2">1. é¸æ“‡æˆ–æ–°å¢æª¢æŸ¥è¡¨</h3>
            <div class="flex gap-2">
                <select id="adminFormSelector" onchange="loadAdminItems()" class="flex-1 p-2 border rounded"></select>
                <button onclick="addNewFormType()" class="bg-green-600 text-white px-3 rounded shadow font-bold">+</button>
                <button onclick="deleteFormType()" class="bg-red-600 text-white px-3 rounded shadow font-bold">ğŸ—‘ï¸</button>
            </div>
        </div>

        <div class="paper-card">
            <h3 class="font-bold text-gray-700 mb-2 flex justify-between">
                2. ç·¨è¼¯æª¢æŸ¥é …ç›®
                <button onclick="addNewItem()" class="text-xs bg-blue-600 text-white px-2 py-1 rounded">+ æ–°å¢é …ç›®</button>
            </h3>
            <div id="adminItemsList" class="space-y-3">
                </div>
        </div>

        <button onclick="saveAllConfig()" class="w-full bg-gray-800 text-white font-bold py-3 rounded-lg shadow mt-4 mb-20">
            ğŸ’¾ å„²å­˜æ‰€æœ‰è¨­å®š (Save)
        </button>
    </div>

    <nav class="nav-bar">
        <div class="nav-item active" onclick="switchPage('check', this)">
            <span class="nav-icon">ğŸ“‹</span>
            ç¾å ´æª¢æŸ¥
        </div>
        <div class="nav-item" onclick="switchPage('admin', this)">
            <span class="nav-icon">âš™ï¸</span>
            å¾Œå°è¨­å®š
        </div>
    </nav>

<script>
    if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');

    // ==========================================
    // è³‡æ–™æ ¸å¿ƒ (é è¨­è³‡æ–™)
    // ==========================================
    const defaultData = {
        "rebar": { title: "ğŸ—ï¸ é‹¼ç­‹å·¥ç¨‹", items: [
            { id: "r1", name: "é‹¼ç­‹è™Ÿæ•¸", standard: "ç¬¦åˆåœ–èªª", type: "text" },
            { id: "r2", name: "é‹¼ç­‹é–“è·", standard: "è¨­è¨ˆå€¼ Â±10mm", type: "number" }
        ]},
        "formwork": { title: "ğŸ§± æ¨¡æ¿å·¥ç¨‹", items: [
            { id: "f1", name: "å‚ç›´åº¦", standard: "3m < 6mm", type: "number" }
        ]}
    };

    // å˜—è©¦å¾ localStorage è®€å–ï¼Œå¦‚æœæ²’æœ‰å°±ç”¨é è¨­å€¼
    let appData = JSON.parse(localStorage.getItem('qc_config')) || defaultData;
    let currentEditId = "rebar"; // ç›®å‰æ­£åœ¨ç·¨è¼¯çš„è¡¨å–®ID

    // åˆå§‹åŒ–
    document.getElementById('checkDate').valueAsDate = new Date();
    refreshSelectors();
    loadUserForm();

    // ==========================================
    // é é¢åˆ‡æ›é‚è¼¯
    // ==========================================
    function switchPage(pageName, btn) {
        document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
        document.getElementById(`page-${pageName}`).classList.add('active');
        
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        if(btn) btn.classList.add('active');

        if(pageName === 'admin') loadAdminItems();
        if(pageName === 'check') {
            refreshSelectors();
            loadUserForm();
        }
    }

    // ==========================================
    // User Mode: ç¾å ´æª¢æŸ¥åŠŸèƒ½
    // ==========================================
    function refreshSelectors() {
        const userSel = document.getElementById('userFormSelector');
        const adminSel = document.getElementById('adminFormSelector');
        userSel.innerHTML = '';
        adminSel.innerHTML = '';

        Object.keys(appData).forEach(key => {
            const opt = `<option value="${key}">${appData[key].title}</option>`;
            userSel.innerHTML += opt;
            adminSel.innerHTML += opt;
        });
        
        // ä¿æŒ Admin é¸å–®çš„ç‹€æ…‹
        adminSel.value = currentEditId;
    }

    function loadUserForm() {
        const key = document.getElementById('userFormSelector').value;
        if(!key) return;
        
        const items = appData[key].items;
        const container = document.getElementById('checklistArea');
        let html = '';

        items.forEach((item, idx) => {
            html += `
            <div class="paper-card" id="card-${idx}">
                <div class="font-bold text-gray-800 text-lg mb-1">${idx + 1}. ${item.name}</div>
                <div class="bg-gray-100 p-2 rounded text-sm text-gray-600 mb-2">æ¨™æº–ï¼š${item.standard}</div>
                
                <input type="text" class="input-std mb-2" placeholder="æª¢æŸ¥å€¼...">
                
                <div class="w-full mb-2">
                    <input type="file" id="cam-${idx}" accept="image/*" capture="environment" class="hidden" onchange="previewUserImg(this, ${idx})">
                    <button onclick="document.getElementById('cam-${idx}').click()" class="w-full py-2 border border-dashed border-gray-400 text-gray-500 rounded font-bold">ğŸ“· æ‹æ”ç…§ç‰‡</button>
                    <img id="img-${idx}" class="photo-preview">
                </div>

                <div class="flex gap-2">
                    <button onclick="toggleBtn(this, 'pass')" class="btn-base flex-1">åˆæ ¼</button>
                    <button onclick="toggleBtn(this, 'fail')" class="btn-base flex-1">ç¼ºå¤±</button>
                </div>
            </div>`;
        });
        container.innerHTML = html;
    }

    function previewUserImg(input, idx) {
        if (input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = document.getElementById(`img-${idx}`);
                img.src = e.target.result;
                img.classList.add('show');
                input.nextElementSibling.innerText = "ğŸ“· ç…§ç‰‡å·²æš«å­˜";
                input.nextElementSibling.classList.add('bg-blue-50', 'text-blue-600');
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function toggleBtn(btn, type) {
        const parent = btn.parentElement;
        parent.querySelectorAll('button').forEach(b => b.className = "btn-base flex-1");
        if(type === 'pass') btn.className = "btn-base flex-1 btn-pass-active";
        else btn.className = "btn-base flex-1 btn-fail-active";
    }

    function submitData() {
        Swal.fire({ title: 'æª¢æŸ¥å®Œæˆ!', text: 'è³‡æ–™èˆ‡ç…§ç‰‡å·²æ¨¡æ“¬ä¸Šå‚³æˆåŠŸ', icon: 'success' });
    }

    // ==========================================
    // Admin Mode: å¾Œå°è¨­å®šåŠŸèƒ½
    // ==========================================
    
    // 1. æ–°å¢è¡¨å–®ç¨®é¡ (ä¾‹å¦‚: æ–°å¢ã€Œæ²¹æ¼†å·¥ç¨‹ã€)
    async function addNewFormType() {
        const { value: formName } = await Swal.fire({
            title: 'æ–°å¢æª¢æŸ¥è¡¨åç¨±',
            input: 'text',
            inputLabel: 'ä¾‹å¦‚ï¼šæ²¹æ¼†å·¥ç¨‹æª¢æŸ¥è¡¨',
            showCancelButton: true
        });

        if (formName) {
            const newId = "form_" + Date.now();
            appData[newId] = { title: formName, items: [] };
            currentEditId = newId;
            saveAllConfig(); // è‡ªå‹•å„²å­˜
            refreshSelectors();
            loadAdminItems();
            Swal.fire('æˆåŠŸ', 'å·²å»ºç«‹æ–°è¡¨å–®ï¼Œè«‹é–‹å§‹æ–°å¢é …ç›®', 'success');
        }
    }

    // 2. åˆªé™¤è¡¨å–®
    function deleteFormType() {
        const key = document.getElementById('adminFormSelector').value;
        if(Object.keys(appData).length <= 1) return Swal.fire('éŒ¯èª¤', 'è‡³å°‘è¦ä¿ç•™ä¸€å¼µè¡¨å–®', 'error');

        Swal.fire({
            title: 'ç¢ºå®šåˆªé™¤æ­¤è¡¨å–®ï¼Ÿ',
            text: "åˆªé™¤å¾Œç„¡æ³•å¾©åŸï¼",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'æ˜¯çš„ï¼Œåˆªé™¤'
        }).then((result) => {
            if (result.isConfirmed) {
                delete appData[key];
                currentEditId = Object.keys(appData)[0]; // åˆªé™¤å¾Œè·³å›ç¬¬ä¸€å¼µ
                saveAllConfig();
                refreshSelectors();
                loadAdminItems();
            }
        });
    }

    // 3. è¼‰å…¥ç·¨è¼¯åˆ—è¡¨
    function loadAdminItems() {
        currentEditId = document.getElementById('adminFormSelector').value;
        const items = appData[currentEditId].items;
        const list = document.getElementById('adminItemsList');
        list.innerHTML = '';

        items.forEach((item, index) => {
            list.innerHTML += `
            <div class="border p-3 rounded bg-white relative">
                <div class="text-xs text-gray-400 mb-1">é …ç›® ${index + 1}</div>
                <input type="text" class="w-full border-b mb-2 p-1 font-bold" value="${item.name}" onchange="updateItem(${index}, 'name', this.value)" placeholder="æª¢æŸ¥é …ç›®åç¨±">
                <input type="text" class="w-full border-b mb-2 p-1 text-sm text-gray-600" value="${item.standard}" onchange="updateItem(${index}, 'standard', this.value)" placeholder="æª¢æŸ¥æ¨™æº–">
                <button onclick="deleteItem(${index})" class="absolute top-2 right-2 text-red-500 font-bold px-2">âœ•</button>
            </div>`;
        });
    }

    // 4. æ–°å¢ç´°é …
    function addNewItem() {
        appData[currentEditId].items.push({ 
            id: Date.now(), 
            name: "æ–°æª¢æŸ¥é …ç›®", 
            standard: "è«‹è¼¸å…¥æ¨™æº–", 
            type: "text" 
        });
        loadAdminItems();
    }

    // 5. æ›´æ–°ç´°é …å…§å®¹
    function updateItem(index, field, val) {
        appData[currentEditId].items[index][field] = val;
    }

    // 6. åˆªé™¤ç´°é …
    function deleteItem(index) {
        appData[currentEditId].items.splice(index, 1);
        loadAdminItems();
    }

    // 7. å„²å­˜è¨­å®š (å­˜åˆ° LocalStorage)
    function saveAllConfig() {
        localStorage.setItem('qc_config', JSON.stringify(appData));
        const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 1500 });
        Toast.fire({ icon: 'success', title: 'è¨­å®šå·²å„²å­˜' });
        // åŒæ­¥æ›´æ–°ç¾å ´æ¨¡å¼
        refreshSelectors();
    }
</script>

</body>
</html>